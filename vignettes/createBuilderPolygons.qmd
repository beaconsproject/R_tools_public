---
title: "Create builder polygons"
format: html
---


## Intro

This script generates potential benchmarks, as well as upstream and downstream polygons based on the **BUILDER** output. 

The first step is to locate catchments layer and specify the directory where BUILDER output were saved. 

These polygons are then used to [assess dendritic connectivity](calcDCI.html) by clipping the stream network to each polygon and analyzing how water flows within its boundaries.

### Generate potential benchmarks, upstream and downstream polygons from catchments using **BUILDER** output files

Function `fetch_builder_output` allow to read Builder output tables that uses column format. The output can then be passed to dissolve_catchment_from_table to generate polygons using enumerated 'CATCHNUM'. `fetch_builder_output` needs the following:

- **out_dir**: Point to a directory that contains Builder output
- **type**: Indicate which file to read. Type can be 'BENCHMARKS', 'UPSTREAM' or 'DOWNSTREAM'. Default is 'BENCHMARKS'.


```r
# Load libraries
library(sf)
library(dplyr)
library(utils)


# --------------------------------------
# SET PARAMS  --------------------
# --------------------------------------
# Set working directory
dirpath <- "path/to/BEACONs_R_tools"

setwd(dirpath)
source("./R/spatial.R")

# Set Builder output path
builder_dir <- file.path(dirpath, "Builder_output")

# Create the folder structure
out_dir <- file.path(dirpath, "shp_output")
if (!dir.exists(out_dir)) {
  dir.create(out_dir, recursive = TRUE)
}

# Set catchments layer access path and initialize
catchments_sf <- st_read(file.path(dirpath, "data/catchments.shp"))

# Prefix given to identify unique conservation areas
colName <- "PB"


# --------------------------------------
#--RUN
# --------------------------------------
type <- "BENCHMARKS"
out_tab <- fetch_builder_output(builder_dir, type = type)

# Convert builder output tables to polygons
poly_sf <- dissolve_catchments_from_table(catchments_sf = catchments_sf, 
                                             input_table = out_tab, 
                                             out_feature_id = colName)

write_sf(poly_sf, dsn =file.path(out_dir, "benchmarks_poly.shp"), append = FALSE)

#############################################
#  Generate upstream polygons
#############################################
type <- "UPSTREAM"
out_tab <- fetch_builder_output(builder_dir, type = type)

# Convert builder output tables to polygons
poly_sf <- dissolve_catchments_from_table(catchments_sf = catchments_sf, 
                                             input_table = out_tab, 
                                             out_feature_id = colName)

write_sf(poly_sf, dsn =file.path(out_dir, "upstream_poly.shp"), append = FALSE)

#############################################
#  Generate downstream polygons
#############################################
type <- "DOWNSTREAM"
out_tab <- fetch_builder_output(builder_dir, type = type)

# Convert builder output tables to polygons
poly_sf <- dissolve_catchments_from_table(catchments_sf = catchments_sf, 
                                             input_table = out_tab, 
                                             out_feature_id = colName)

write_sf(poly_sf, dsn =file.path(out_dir, "downstream_poly.shp"), append = FALSE)
```

